<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jace订单簿 - 迷因交易中心</title>
    <link rel="icon" type="image/jpeg" href="https://woofswap.finance/image/tokens/jace.png">
    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: #fff;
            font-family: 'VT323', monospace;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(0, 179, 108, 0.05) 1px, transparent 1px);
            background-size: 100% 4px;
            z-index: 0;
            pointer-events: none;
        }

        header {
            position: fixed;
            width: 100%;
            z-index: 50;
            padding: 15px 0;
            background: rgba(0, 0, 0, 0.9);
            border-bottom: 2px solid #00B36C;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-img {
            width: 40px;
            height: 40px;
            filter: drop-shadow(0 0 8px #00B36C);
            animation: crt-flicker 0.1s infinite;
        }

        @keyframes crt-flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.95; }
        }

        nav a {
            color: #00B36C;
            font-size: 1.4em;
            text-decoration: none;
            margin: 0 12px;
            text-shadow: 0 0 5px #00B36C;
            transition: all 0.3s;
        }

        nav a:hover {
            background: #00B36C;
            color: #000;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .menu-toggle {
            display: none;
            font-size: 1.6em;
            cursor: pointer;
            color: #00B36C;
        }

        #mobile-menu {
            display: none;
            background: rgba(0, 0, 0, 0.9);
            padding: 15px;
            position: absolute;
            top: 100%;
            width: 100%;
            flex-direction: column;
            align-items: center;
        }

        #mobile-menu a {
            margin: 8px 0;
            font-size: 1.4em;
            color: #00B36C;
        }

        section {
            padding: 70px 20px;
            position: relative;
            z-index: 1;
        }

        h1 {
            font-size: 2.8em;
            text-align: center;
            text-transform: uppercase;
            text-shadow: 0 0 12px #00B36C;
            margin-bottom: 15px;
            color: #fff;
        }

        h2 {
            font-size: 2em;
            text-align: center;
            text-shadow: 0 0 8px #00B36C;
            margin-bottom: 15px;
            color: #fff;
        }

        p {
            font-size: 1.2em;
            line-height: 1.4;
            text-align: center;
            max-width: 800px;
            margin: 0 auto 15px;
            color: #fff;
        }

        .order-section {
            background: #1a1a1a;
            padding: 15px;
            border: 2px solid #00B36C;
            border-radius: 8px;
            margin: 15px auto;
            max-width: 900px;
            box-shadow: 0 0 15px rgba(0, 179, 108, 0.3);
        }

        .input-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin: 10px 0;
        }

        input, button {
            font-family: 'VT323', monospace;
            font-size: 1.1em;
            padding: 8px;
            border: 1px solid #00B36C;
            background: #1a1a1a;
            color: #fff;
            border-radius: 4px;
            transition: all 0.3s;
        }

        button {
            background: #00B36C;
            color: #000;
            cursor: pointer;
        }

        button:hover {
            background: #009955;
            box-shadow: 0 0 8px #00B36C;
        }

        button:disabled, .loading {
            background: #004d2e;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .token-info {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #fff;
        }

        .token-info img {
            width: 18px;
            height: 18px;
            margin-right: 8px;
        }

        .percentage-buttons {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 8px 0;
        }

        .percentage-btn {
            background: #00B36C;
            color: #000;
            padding: 6px 12px;
            font-size: 0.9em;
            min-width: 50px;
            border-radius: 4px;
        }

        .percentage-btn:hover {
            background: #009955;
        }

        .balance-info, .price-info {
            font-size: 1em;
            color: #00B36C;
            margin: 8px 0;
            text-align: center;
        }

        .order-list {
            padding: 12px;
            background: #1a1a1a;
            border: 1px dotted #00B36C;
            border-radius: 8px;
            margin-top: 12px;
        }

        .user-order-list {
            max-height: 250px;
            overflow-y: auto;
        }

        .order-item {
            margin: 6px 0;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }

        .active-order-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }

        .order-box {
            background: rgba(0, 179, 108, 0.1);
            padding: 12px;
            border: 2px solid #00B36C;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 0 10px rgba(0, 179, 108, 0.4);
            transition: transform 0.3s;
        }

        .order-box:hover {
            transform: scale(1.05);
        }

        .order-box span {
            display: block;
            margin: 4px 0;
            font-size: 0.95em;
        }

        .order-box img {
            width: 18px;
            height: 18px;
            margin-right: 8px;
        }

        .order-box button {
            padding: 6px 12px;
            font-size: 0.9em;
            min-width: 90px;
            margin-top: 8px;
        }

        .status {
            font-size: 1em;
            color: #00B36C;
            text-align: center;
            margin: 8px 0;
        }

        .contract {
            background: #1a1a1a;
            padding: 10px;
            font-size: 1em;
            word-break: break-all;
            text-align: center;
            border: 1px dotted #00B36C;
            margin: 15px auto;
            max-width: 600px;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .contract-short {
            font-size: 1em;
        }

        .copy-button {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            font-size: 0.9em;
            background: #1a1a1a;
            border: 1px solid #00B36C;
            color: #fff;
            border-radius: 4px;
        }

        .copy-button:hover:not(:disabled) {
            background: #009955;
            color: #000;
        }

        .cursor {
            display: inline-block;
            width: 8px;
            height: 1.1em;
            background: #00B36C;
            animation: blink 0.7s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        footer {
            text-align: center;
            padding: 25px;
            background: #000;
            border-top: 2px solid #00B36C;
            color: #fff;
            font-size: 1em;
        }

        @media (max-width: 768px) {
            nav {
                display: none;
            }

            .menu-toggle {
                display: block;
            }

            #mobile-menu.active {
                display: flex;
            }

            h1 {
                font-size: 2.2em;
            }

            h2 {
                font-size: 1.6em;
            }

            .logo-img {
                width: 35px;
                height: 35px;
            }

            .input-group {
                flex-direction: column;
            }

            input {
                width: 100%;
                margin: 4px 0;
            }

            .active-order-grid {
                grid-template-columns: 1fr;
            }

            .order-box {
                padding: 10px;
            }

            .order-box button {
                width: 100%;
            }

            .contract {
                flex-direction: column;
                gap: 5px;
            }
        }

        @media (min-width: 769px) and (max-width: 1000px) {
            .container {
                padding: 0 25px;
            }

            .active-order-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container nav-container">
            <img src="https://woofswap.finance/image/tokens/jace.png" alt="Jace订单簿 Logo" class="logo-img">
            <nav>
                <a href="#orders">订单簿</a>
                <a href="#about">关于</a>
                <a href="#trade">交易</a>
                <a href="#community">社区</a>
            </nav>
            <div class="menu-toggle"><i class="fa fa-bars"></i></div>
            <div id="mobile-menu">
                <a href="#orders">订单簿</a>
                <a href="#about">关于</a>
                <a href="#trade">交易</a>
                <a href="#community">社区</a>
            </div>
        </div>
    </header>

    <main>
        <section id="orders" class="min-h-screen flex items-center justify-center" style="padding-top: 80px;">
            <div class="container">
                <h1>Jace订单簿 - 迷因交易中心<span class="cursor"></span></h1>
                <p>在 X Layer 上交易 X0 兑换 OKB！设置价格，创建或购买订单。</p>

                <div class="order-section">
                    <h2>活跃订单</h2>
                    <div class="token-info">
                        <img src="https://woofswap.finance/image/tokens/xo.png" alt="X0"> X0
                    </div>
                    <div class="input-group">
                        <button id="queryOrdersButton">查询订单</button>
                    </div>
                    <div class="order-list" id="activeOrders">
                        <div class="active-order-grid"></div>
                    </div>
                </div>

                <div class="order-section" style="max-width: 600px;">
                    <h2>连接钱包</h2>
                    <div class="input-group">
                        <button id="connectButton">连接 MetaMask</button>
                        <button id="withdrawFeesButton" style="display:none;">提取手续费</button>
                    </div>
                    <p>钱包: <span id="walletAddress">未连接</span></p>
                    <p>手续费余额: <span id="feeBalance">0 OKB</span></p>
                    <div id="networkStatus" class="status">点击连接...</div>
                </div>

                <div class="order-section" style="max-width: 600px;">
                    <h2>创建订单</h2>
                    <div class="token-info">
                        <img src="https://woofswap.finance/image/tokens/xo.png" alt="X0"> X0
                    </div>
                    <div class="input-group">
                        <input type="number" id="amountInInput" placeholder="输入 X0 数量" min="0" step="any">
                        <input type="number" id="amountOKBInput" placeholder="OKB 数量 (最少 0.01)" min="0.01" step="any">
                    </div>
                    <div class="balance-info" id="tokenBalance">X0 余额: 0</div>
                    <div class="percentage-buttons">
                        <button class="percentage-btn" onclick="setPercentage(25)">25%</button>
                        <button class="percentage-btn" onclick="setPercentage(50)">50%</button>
                        <button class="percentage-btn" onclick="setPercentage(75)">75%</button>
                        <button class="percentage-btn" onclick="setPercentage(100)">100%</button>
                    </div>
                    <div class="price-info" id="priceInfo">每 X0 价格: 0 OKB</div>
                    <div class="input-group">
                        <button id="createOrderButton">批准并创建订单</button>
                    </div>
                    <div class="order-list user-order-list" id="userOrders"></div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 Jace订单簿. 所有系统正常。保持联系。<span class="cursor"></span></p>
    </footer>

    <script>
        let web3, accounts, contract;
        const contractAddress = "0xe9B1DFb78414fEf5fb7533c0B917f85ac17866F5";
        const tokenAddress = "0x428dC4b69A05C128966f2A03693dEAac409F1EC5";
        const tokenInfo = { symbol: "X0", logo: "https://woofswap.finance/image/tokens/xo.png", decimals: 18, priceDecimals: 8 };
        const contractABI = [
            {
                "inputs": [],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "uint256",
                        "name": "orderId",
                        "type": "uint256"
                    }
                ],
                "name": "OrderCancelled",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "uint256",
                        "name": "orderId",
                        "type": "uint256"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "trader",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "address",
                        "name": "tokenIn",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "amountIn",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "amountOKB",
                        "type": "uint256"
                    }
                ],
                "name": "OrderCreated",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "uint256",
                        "name": "orderId",
                        "type": "uint256"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "buyer",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "amountIn",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "amountOKB",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "feeAmount",
                        "type": "uint256"
                    }
                ],
                "name": "OrderFilled",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "FeesWithdrawn",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "token",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "bool",
                        "name": "isWhitelisted",
                        "type": "bool"
                    }
                ],
                "name": "TokenWhitelisted",
                "type": "event"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "_orderId",
                        "type": "uint256"
                    }
                ],
                "name": "buy",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "_orderId",
                        "type": "uint256"
                    }
                ],
                "name": "cancelOrder",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "_tokenIn",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "_amountIn",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "_amountOKB",
                        "type": "uint256"
                    }
                ],
                "name": "createOrder",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "orderId",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "activeOrdersByToken",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "feeBalance",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "_tokenIn",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "_page",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "_perPage",
                        "type": "uint256"
                    }
                ],
                "name": "getActiveOrders",
                "outputs": [
                    {
                        "components": [
                            {
                                "internalType": "uint256",
                                "name": "id",
                                "type": "uint256"
                            },
                            {
                                "internalType": "address",
                                "name": "trader",
                                "type": "address"
                            },
                            {
                                "internalType": "address",
                                "name": "tokenIn",
                                "type": "address"
                            },
                            {
                                "internalType": "uint256",
                                "name": "amountIn",
                                "type": "uint256"
                            },
                            {
                                "internalType": "uint256",
                                "name": "amountOKB",
                                "type": "uint256"
                            },
                            {
                                "internalType": "bool",
                                "name": "isActive",
                                "type": "bool"
                            }
                        ],
                        "internalType": "struct JaceLimitOrder.Order[]",
                        "name": "",
                        "type": "tuple[]"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "_user",
                        "type": "address"
                    }
                ],
                "name": "getActiveOrderIds",
                "outputs": [
                    {
                        "internalType": "uint256[]",
                        "name": "",
                        "type": "uint256[]"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getFeeBalance",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "_orderId",
                        "type": "uint256"
                    }
                ],
                "name": "getOrder",
                "outputs": [
                    {
                        "components": [
                            {
                                "internalType": "uint256",
                                "name": "id",
                                "type": "uint256"
                            },
                            {
                                "internalType": "address",
                                "name": "trader",
                                "type": "address"
                            },
                            {
                                "internalType": "address",
                                "name": "tokenIn",
                                "type": "address"
                            },
                            {
                                "internalType": "uint256",
                                "name": "amountIn",
                                "type": "uint256"
                            },
                            {
                                "internalType": "uint256",
                                "name": "amountOKB",
                                "type": "uint256"
                            },
                            {
                                "internalType": "bool",
                                "name": "isActive",
                                "type": "bool"
                            }
                        ],
                        "internalType": "struct JaceLimitOrder.Order",
                        "name": "",
                        "type": "tuple"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "_user",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "_page",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "_perPage",
                        "type": "uint256"
                    }
                ],
                "name": "getUserOrders",
                "outputs": [
                    {
                        "components": [
                            {
                                "internalType": "uint256",
                                "name": "id",
                                "type": "uint256"
                            },
                            {
                                "internalType": "address",
                                "name": "trader",
                                "type": "address"
                            },
                            {
                                "internalType": "address",
                                "name": "tokenIn",
                                "type": "address"
                            },
                            {
                                "internalType": "uint256",
                                "name": "amountIn",
                                "type": "uint256"
                            },
                            {
                                "internalType": "uint256",
                                "name": "amountOKB",
                                "type": "uint256"
                            },
                            {
                                "internalType": "bool",
                                "name": "isActive",
                                "type": "bool"
                            }
                        ],
                        "internalType": "struct JaceLimitOrder.Order[]",
                        "name": "",
                        "type": "tuple[]"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "nextOrderId",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "orders",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "id",
                        "type": "uint256"
                    },
                    {
                        "internalType": "address",
                        "name": "trader",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "tokenIn",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "amountIn",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "amountOKB",
                        "type": "uint256"
                    },
                    {
                        "internalType": "bool",
                        "name": "isActive",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "ordersByUser",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "owner",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "name": "whitelistedTokens",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "withdrawFees",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "_token",
                        "type": "address"
                    },
                    {
                        "internalType": "bool",
                        "name": "_isWhitelisted",
                        "type": "bool"
                    }
                ],
                "name": "whitelistToken",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "stateMutability": "payable",
                "type": "receive"
            }
        ];
        const erc20ABI = [
            {"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"},
            {"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","outputs":[{"name":"success","type":"bool"}],"type":"function"},
            {"constant":true,"inputs":[],"name":"symbol","outputs":[{"name":"","type":"string"}],"type":"function"}
        ];
        const xLayer = {
            chainId: 196,
            chainName: 'X Layer mainnet',
            nativeCurrency: { name: 'OKB', symbol: 'OKB', decimals: 18 },
            rpcUrls: ['https://rpc.xlayer.tech'],
            blockExplorerUrls: ['https://www.okx.com/web3/explorer/xlayer']
        };

        async function connectWallet() {
            const status = document.getElementById('networkStatus');
            const connectButton = document.getElementById('connectButton');
            try {
                if (!window.ethereum) {
                    status.innerHTML = '未检测到钱包。请安装 <a href="https://metamask.io" target="_blank">MetaMask</a>。';
                    throw new Error("未检测到钱包");
                }
                connectButton.classList.add('loading');
                status.innerText = "正在连接...";
                web3 = new Web3(window.ethereum);
                accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (!accounts.length) throw new Error("请解锁或连接钱包。");
                const chainId = await web3.eth.getChainId();
                if (chainId !== 196) {
                    try {
                        await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0xc4' }] });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [xLayer]
                            });
                        } else throw switchError;
                    }
                }
                document.getElementById('walletAddress').innerText = `${accounts[0].slice(0, 6)}...${accounts[0].slice(-4)}`;
                contract = new web3.eth.Contract(contractABI, contractAddress);
                status.innerText = "已连接到 X Layer";
                await updateFeeBalance();
                await updateBalance();
                await updateUserOrders();
                await queryOrders();
            } catch (error) {
                console.error(error);
                status.innerText = `连接失败: ${error.message}`;
            } finally {
                connectButton.classList.remove('loading');
            }
        }

        async function updateBalance() {
            if (!contract || !accounts) return;
            const tokenContract = new web3.eth.Contract(erc20ABI, tokenAddress);
            const balanceWei = await tokenContract.methods.balanceOf(accounts[0]).call();
            const balance = web3.utils.fromWei(balanceWei, 'ether');
            document.getElementById('tokenBalance').innerText = `X0 余额: ${parseFloat(balance).toFixed(3)} X0`;
        }

        function setPercentage(percentage) {
            if (!contract || !accounts) return;
            updateBalance().then(async () => {
                const tokenContract = new web3.eth.Contract(erc20ABI, tokenAddress);
                const balanceWei = await tokenContract.methods.balanceOf(accounts[0]).call();
                const balance = parseFloat(web3.utils.fromWei(balanceWei, 'ether'));
                let amount;
                if (percentage === 100) {
                    amount = balance > 0.01 ? (balance - 0.01).toFixed(3) : 0;
                } else {
                    amount = (balance * percentage / 100).toFixed(3);
                }
                document.getElementById('amountInInput').value = amount;
                updatePrice();
            });
        }

        function updatePrice() {
            const amountIn = parseFloat(document.getElementById('amountInInput').value) || 0;
            const amountOKB = parseFloat(document.getElementById('amountOKBInput').value) || 0;
            const price = amountIn > 0 ? (amountOKB / amountIn).toFixed(tokenInfo.priceDecimals) : 0;
            document.getElementById('priceInfo').innerText = `每 X0 价格: ${price} OKB`;
        }

        async function createOrder() {
            if (!contract || !accounts) return alert("请先连接 MetaMask！");
            const amountIn = document.getElementById('amountInInput').value;
            const amountOKB = document.getElementById('amountOKBInput').value;
            if (!amountIn || !amountOKB || amountOKB < 0.01) return alert("输入无效！OKB 数量至少为 0.01。");
            const amountInWei = web3.utils.toWei(amountIn.toString(), 'ether');
            const amountOKBWei = web3.utils.toWei(amountOKB.toString(), 'ether');
            const tokenContract = new web3.eth.Contract(erc20ABI, tokenAddress);
            try {
                await tokenContract.methods.approve(contractAddress, amountInWei).send({ from: accounts[0] });
                await contract.methods.createOrder(tokenAddress, amountInWei, amountOKBWei).send({ from: accounts[0] });
                alert("订单创建成功！");
                await updateUserOrders();
                await queryOrders();
            } catch (error) {
                console.error(error);
                alert(`创建订单失败: ${error.message}`);
            }
        }

        async function buyOrder(orderId, amountOKB) {
            if (!contract || !accounts) return alert("请先连接 MetaMask！");
            try {
                await contract.methods.buy(orderId).send({ from: accounts[0], value: web3.utils.toWei(amountOKB.toString(), 'ether') });
                alert("订单购买成功！");
                await updateUserOrders();
                await queryOrders();
            } catch (error) {
                console.error(error);
                alert(`购买订单失败: ${error.message}`);
            }
        }

        async function cancelOrder(orderId) {
            if (!contract || !accounts) return alert("请先连接 MetaMask！");
            try {
                await contract.methods.cancelOrder(orderId).send({ from: accounts[0] });
                alert("订单取消成功！");
                await updateUserOrders();
                await queryOrders();
            } catch (error) {
                console.error(error);
                alert(`取消订单失败: ${error.message}`);
            }
        }

        async function updateFeeBalance() {
            if (!contract || !accounts) return;
            const owner = await contract.methods.owner().call();
            const isOwner = accounts[0].toLowerCase() === owner.toLowerCase();
            document.getElementById('withdrawFeesButton').style.display = isOwner ? 'inline-block' : 'none';
            const feeBalanceWei = await contract.methods.getFeeBalance().call();
            const feeBalance = web3.utils.fromWei(feeBalanceWei, 'ether');
            document.getElementById('feeBalance').innerText = `${parseFloat(feeBalance).toFixed(3)} OKB`;
        }

        async function withdrawFees() {
            if (!contract || !accounts) return alert("请先连接 MetaMask！");
            try {
                await contract.methods.withdrawFees().send({ from: accounts[0] });
                alert("手续费提取成功！");
                await updateFeeBalance();
            } catch (error) {
                console.error(error);
                alert(`提取手续费失败: ${error.message}`);
            }
        }

        async function updateUserOrders() {
            if (!contract || !accounts) return;
            const userOrdersDiv = document.getElementById('userOrders');
            const userOrders = await contract.methods.getUserOrders(accounts[0], 0, 10).call();
            userOrdersDiv.innerHTML = userOrders.length ? '' : '<p>暂无订单。</p>';
            userOrders.forEach(order => {
                const amountIn = web3.utils.fromWei(order.amountIn, 'ether');
                const amountOKB = web3.utils.fromWei(order.amountOKB, 'ether');
                const price = amountIn > 0 ? (Number(amountOKB) / Number(amountIn)).toFixed(tokenInfo.priceDecimals) : 0;
                userOrdersDiv.innerHTML += `
                    <div class="order-item">
                        <span>订单ID: ${order.id} | <img src="${tokenInfo.logo}" alt="${tokenInfo.symbol}"> ${tokenInfo.symbol} ${parseFloat(amountIn).toFixed(3)} 兑换 ${parseFloat(amountOKB).toFixed(3)} OKB | 价格: ${price} OKB/${tokenInfo.symbol}</span>
                        ${order.isActive ? `<button onclick="cancelOrder('${order.id}')">取消</button>` : '<span>已完成</span>'}
                    </div>
                `;
            });
        }

        async function queryOrders() {
            if (!contract || !accounts) return alert("请先连接 MetaMask！");
            const activeOrdersDiv = document.getElementById('activeOrders').querySelector('.active-order-grid');
            const activeOrders = await contract.methods.getActiveOrders(tokenAddress, 0, 50).call();
            activeOrdersDiv.innerHTML = activeOrders.length ? '' : '<p>暂无活跃订单。</p>';
            activeOrders.forEach(order => {
                const amountIn = web3.utils.fromWei(order.amountIn, 'ether');
                const amountOKB = web3.utils.fromWei(order.amountOKB, 'ether');
                const price = amountIn > 0 ? (Number(amountOKB) / Number(amountIn)).toFixed(tokenInfo.priceDecimals) : 0;
                activeOrdersDiv.innerHTML += `
                    <div class="order-box">
                        <span>订单ID: ${order.id}</span>
                        <span><img src="${tokenInfo.logo}" alt="${tokenInfo.symbol}"> ${tokenInfo.symbol}</span>
                        <span>数量: ${parseFloat(amountIn).toFixed(3)}</span>
                        <span>OKB: ${parseFloat(amountOKB).toFixed(3)}</span>
                        <span>价格: ${price} OKB/${tokenInfo.symbol}</span>
                        <button onclick="buyOrder('${order.id}', '${amountOKB}')">购买</button>
                    </div>
                `;
            });
        }

        function copyContractAddress() {
            const status = document.getElementById('networkStatus');
            const contractAddressElement = document.querySelector('#about .contract-short');
            const textToCopy = contractAddressElement.dataset.fullAddress;
            const buttonElement = document.getElementById('copyContractAddressButton');

            if (!textToCopy) {
                status.textContent = "没有有效的合约地址可复制";
                return;
            }

            navigator.clipboard.writeText(textToCopy).then(() => {
                status.textContent = "已复制到剪切板";
                buttonElement.innerHTML = `<i class="fa fa-check"></i> 已复制!`;
                setTimeout(() => {
                    status.textContent = "";
                    buttonElement.innerHTML = `<i class="fa fa-copy"></i> 复制`;
                }, 2000);
            }).catch(error => {
                console.error("复制失败:", error);
                status.textContent = "无法复制合约地址，请手动选择并复制。";
            });
        }

        function setupMobileMenu() {
            const menuToggle = document.querySelector('.menu-toggle');
            const mobileMenu = document.getElementById('mobile-menu');
            if (menuToggle && mobileMenu) {
                menuToggle.addEventListener('click', () => {
                    mobileMenu.classList.toggle('active');
                    menuToggle.innerHTML = mobileMenu.classList.contains('active') ? '<i class="fa fa-times"></i>' : '<i class="fa fa-bars"></i>';
                });
            }
        }

        function setupSmoothScroll() {
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', (e) => {
                    e.preventDefault();
                    const mobileMenu = document.getElementById('mobile-menu');
                    const menuToggle = document.querySelector('.menu-toggle');
                    if (mobileMenu && menuToggle) {
                        mobileMenu.classList.remove('active');
                        menuToggle.innerHTML = '<i class="fa fa-bars"></i>';
                    }
                    document.querySelector(anchor.getAttribute('href')).scrollIntoView({ behavior: 'smooth' });
                });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            setupMobileMenu();
            setupSmoothScroll();

            document.getElementById('connectButton').addEventListener('click', connectWallet);
            document.getElementById('createOrderButton').addEventListener('click', createOrder);
            document.getElementById('queryOrdersButton').addEventListener('click', queryOrders);
            document.getElementById('amountInInput').addEventListener('input', updatePrice);
            document.getElementById('amountOKBInput').addEventListener('input', updatePrice);
            document.getElementById('copyContractAddressButton').addEventListener('click', copyContractAddress);
            document.getElementById('withdrawFeesButton').addEventListener('click', withdrawFees);

            if (!window.location.protocol.startsWith('http')) {
                document.getElementById('networkStatus').innerHTML = '请通过本地服务器运行此页面（例如，"npx serve"）以连接 MetaMask。';
            } else if (!window.ethereum) {
                document.getElementById('networkStatus').innerHTML = '未检测到钱包。请安装 <a href="https://metamask.io" target="_blank">MetaMask</a>。';
            }
        });

        window.ethereum?.on('chainChanged', (chainId) => {
            if (parseInt(chainId, 16) !== 196) {
                document.getElementById('networkStatus').innerText = "网络错误。请重新连接到 X Layer。";
                web3 = null; contract = null; accounts = null;
                document.getElementById('walletAddress').innerText = "未连接";
            } else connectWallet();
        });

        window.ethereum?.on('accountsChanged', (newAccounts) => {
            if (newAccounts.length) connectWallet();
            else {
                document.getElementById('networkStatus').innerText = "钱包已断开连接。请重新连接。";
                web3 = null; contract = null; accounts = null;
                document.getElementById('walletAddress').innerText = "未连接";
            }
        });
    </script>
</body>
</html>
